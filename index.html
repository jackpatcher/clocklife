<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï - Life Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Kanit', sans-serif;
        }
        
        .clock-face {
            width: 600px;
            height: 600px;
            border-radius: 50%;
            position: relative;
            background: var(--clock-gradient, linear-gradient(to bottom, #f9d976 0%, #f39c12 20%, #e96443 40%, #232526 60%, #414345 80%, #000000 100%));
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .hour-mark {
            position: absolute;
            width: 3px;
            height: 30px;
            background: white;
            left: 50%;
            top: 15px;
            transform-origin: 1.5px 285px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .hour-number {
            position: absolute;
            color: white;
            font-weight: 700;
            font-size: 24px;
            transform: translate(-50%, -50%);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 50%;
            min-width: 40px;
            text-align: center;
        }
        
        .activity-segment {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .center-dot {
            position: absolute;
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        .day-night-icon {
            position: absolute;
            font-size: 20px;
            z-index: 15;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        /* Print styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-layout {
                display: flex !important;
                width: 100vw;
                height: 100vh;
                page-break-inside: avoid;
            }
            
            .print-clock {
                flex: 0 0 60%;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            
            .print-info {
                flex: 0 0 40%;
                padding: 20px;
                font-size: 12px;
                line-height: 1.4;
            }
            
            .clock-face {
                width: 500px !important;
                height: 500px !important;
                box-shadow: none !important;
            }
            
            .hour-number {
                font-size: 18px !important;
            }
            
            @page {
                size: A4 landscape;
                margin: 0.5in;
            }
        }
        
        .print-layout {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen p-4">
    <div class="max-w-6xl mx-auto no-print">
        <div class="flex justify-end mb-4">
            <!-- Removed duplicate copy link button -->
        </div>

        <!-- ...existing code... -->
    <!-- ...existing code... -->
    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≤‡∏ü 6 ‡∏™‡∏µ (‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 3, ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô 3) -->
    <div class="flex flex-wrap justify-center gap-6 mt-12 mb-6">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 1</label>
            <input type="color" id="bgDay1" value="#f9d976" class="w-10 h-8 border rounded-lg" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 2</label>
            <input type="color" id="bgDay2" value="#f39c12" class="w-10 h-8 border rounded-lg" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 3</label>
            <input type="color" id="bgDay3" value="#e96443" class="w-10 h-8 border rounded-lg" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô 1</label>
            <input type="color" id="bgNight1" value="#232526" class="w-10 h-8 border rounded-lg" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô 2</label>
            <input type="color" id="bgNight2" value="#414345" class="w-10 h-8 border rounded-lg" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô 3</label>
            <input type="color" id="bgNight3" value="#000000" class="w-10 h-8 border rounded-lg" />
        </div>
    </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üïê ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h1>
            <p class="text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        </div>

        <!-- Owner Name Input -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <label class="block text-lg font-semibold text-gray-700 mb-2">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï:</label>
            <input type="text" id="ownerName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." 
                   class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-lg">
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Clock Display -->
            <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <span id="clockTitle">‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class="text-purple-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠</span></span>
                    </h2>
                    <button onclick="printClock()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
                    </button>
                </div>
                
                <div class="flex justify-center">
                    <div class="clock-face" id="clockFace">
                        <!-- Hour marks and numbers will be generated by JavaScript -->
                        <div class="center-dot"></div>
                        <div id="realtimeClockHands"></div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">üé® ‡∏™‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm" id="colorLegend">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Activity Form -->
            <div class="space-y-6">
                <!-- Add Activity Form -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                            <input type="text" id="activityName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö, ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢..." 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:</label>
                                <div class="flex gap-2">
                                    <select id="startHour" class="flex-1 p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                                        <option value="0">00</option>
                                        <option value="1">01</option>
                                        <option value="2">02</option>
                                        <option value="3">03</option>
                                        <option value="4">04</option>
                                        <option value="5">05</option>
                                        <option value="6">06</option>
                                        <option value="7">07</option>
                                        <option value="8">08</option>
                                        <option value="9" selected>09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                    </select>
                                    <span class="flex items-center text-gray-500">:</span>
                                    <select id="startMinute" class="flex-1 p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                                        <option value="0" selected>00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                                <div class="flex gap-2">
                                    <select id="endHour" class="flex-1 p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                                        <option value="0">00</option>
                                        <option value="1">01</option>
                                        <option value="2">02</option>
                                        <option value="3">03</option>
                                        <option value="4">04</option>
                                        <option value="5">05</option>
                                        <option value="6">06</option>
                                        <option value="7">07</option>
                                        <option value="8">08</option>
                                        <option value="9">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17" selected>17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                    </select>
                                    <span class="flex items-center text-gray-500">:</span>
                                    <select id="endMinute" class="flex-1 p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                                        <option value="0" selected>00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-600 mt-2" id="activityDurationPreview">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: 8.0 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="activityColor" value="#FF6B6B" class="w-12 h-8 p-1 border rounded-lg" />
                                <div id="activityColorPreview" style="width:32px;height:32px;border-radius:8px;border:1px solid #ccc;background:#FF6B6B;"></div>
                            </div>
                        </div>
                        
                        <button onclick="addActivity()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                        </button>
                    </div>
                </div>

                <!-- Activity List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                    <div id="activityList" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    </div>
                </div>

                <!-- Evaluation Form -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">‚≠ê ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°:</label>
                            <div class="flex space-x-2">
                                <button onclick="setRating(1)" class="rating-btn text-2xl p-2 rounded hover:bg-gray-100" data-rating="1">‚≠ê</button>
                                <button onclick="setRating(2)" class="rating-btn text-2xl p-2 rounded hover:bg-gray-100" data-rating="2">‚≠ê</button>
                                <button onclick="setRating(3)" class="rating-btn text-2xl p-2 rounded hover:bg-gray-100" data-rating="3">‚≠ê</button>
                                <button onclick="setRating(4)" class="rating-btn text-2xl p-2 rounded hover:bg-gray-100" data-rating="4">‚≠ê</button>
                                <button onclick="setRating(5)" class="rating-btn text-2xl p-2 rounded hover:bg-gray-100" data-rating="5">‚≠ê</button>
                            </div>
                            <p class="text-sm text-gray-600 mt-1" id="ratingText">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</label>
                            <textarea id="feedback" rows="3" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ..." 
                                      class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none resize-none"></textarea>
                        </div>
                        
                        <button onclick="saveEvaluation()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                        </button>
                    </div>
                </div>
                    <!-- JSON String Input Box (always visible, at the bottom of main container) -->
                <div class="mt-8 mb-8">
                    <label class="block text-lg font-semibold text-gray-700 mb-2">üîó JSON string (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞ background ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á):</label>
                    <textarea id="jsonStringBox" rows="6" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-sm font-mono" spellcheck="false"></textarea>
                    <div class="text-right mt-2">
                        <button id="copyLinkBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Layout -->
    <div class="print-layout">

        <div class="print-clock">
            <div class="clock-face" id="printClockFace">
                <div class="center-dot"></div>
            </div>
        </div>
        <div class="print-info">
            <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center;" id="printTitle">
                ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
            </h1>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</h3>
                <div id="printActivityList"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">üé® ‡∏™‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</h3>
                <div id="printColorLegend"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤:</h3>
                <div id="printStats"></div>
            </div>
            
            <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï - Life Clock | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="printDate"></span>
            </div>
        </div>
    </div>

    <script>
        // On first load, decode data from URL and put in JSON string box, then update UI
        window.addEventListener('DOMContentLoaded', async function() {
            const params = new URLSearchParams(window.location.search);
            const jsonBox = document.getElementById('jsonStringBox');
            if (params.has('data') && jsonBox) {
                try {
                    const encoded = params.get('data');
                    const jsonStr = decodeBase64(encoded);
                    jsonBox.value = jsonStr;
                    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ textarea set ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏à‡∏≤‡∏Å text box
                    await new Promise(resolve => setTimeout(resolve, 0));
                    try {
                        const data = JSON.parse(jsonStr);
                        // owner
                        if (data.owner !== undefined) {
                            document.getElementById('ownerName').value = data.owner;
                        }
                        // background
                        if (data.background) {
                            document.getElementById('bgDay1').value = data.background.bgDay1 || '#f9d976';
                            document.getElementById('bgDay2').value = data.background.bgDay2 || '#f39c12';
                            document.getElementById('bgDay3').value = data.background.bgDay3 || '#e96443';
                            document.getElementById('bgNight1').value = data.background.bgNight1 || '#232526';
                            document.getElementById('bgNight2').value = data.background.bgNight2 || '#414345';
                            document.getElementById('bgNight3').value = data.background.bgNight3 || '#000000';
                        }
                        // activities
                        if (Array.isArray(data.activities)) {
                            activities = data.activities;
                        }
                        updateAllAndUrl();
                    } catch (e) {
                        // ignore if invalid
                    }
                } catch (e) {
                    // ignore if invalid
                }
            }
        });
        // --- ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó real-time ---
        // Real-time polling interval (ms)
        const POLL_INTERVAL = 1000;
        let lastJsonString = '';

        // Base64 encode/decode helpers
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
        function decodeBase64(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        // Copy link with current data in query string
        document.addEventListener('DOMContentLoaded', function() {
            const copyBtn = document.getElementById('copyLinkBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    // Always use the value from the JSON string textarea
                    const jsonStr = document.getElementById('jsonStringBox').value;
                    const base64 = encodeBase64(jsonStr);
                    // Generate link from origin + pathname + ?data=...
                    const url = window.location.origin + window.location.pathname + '?data=' + base64;
                    navigator.clipboard.writeText(url).then(() => {
                        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
                    });
                });
            }
        });

        // Real-time update when JSON string changes
        function startRealtimeJsonPolling() {
            setInterval(() => {
                const jsonBox = document.getElementById('jsonStringBox');
                if (!jsonBox) return;
                const jsonStr = jsonBox.value.trim();
                if (jsonStr && jsonStr !== lastJsonString) {
                    try {
                        const newData = JSON.parse(jsonStr);
                        // owner
                        if (newData.owner !== undefined) {
                            document.getElementById('ownerName').value = newData.owner;
                            // update chart and print title immediately
                            const title = document.getElementById('clockTitle');
                            const printTitle = document.getElementById('printTitle');
                            if (newData.owner) {
                                title.innerHTML = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class="text-purple-600">${newData.owner}</span>`;
                                printTitle.textContent = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ${newData.owner}`;
                            } else {
                                title.innerHTML = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class="text-purple-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠</span>`;
                                printTitle.textContent = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠`;
                            }
                        }
                        // background
                        if (newData.background) {
                            document.getElementById('bgDay1').value = newData.background.bgDay1 || '#f9d976';
                            document.getElementById('bgDay2').value = newData.background.bgDay2 || '#f39c12';
                            document.getElementById('bgDay3').value = newData.background.bgDay3 || '#e96443';
                            document.getElementById('bgNight1').value = newData.background.bgNight1 || '#232526';
                            document.getElementById('bgNight2').value = newData.background.bgNight2 || '#414345';
                            document.getElementById('bgNight3').value = newData.background.bgNight3 || '#000000';
                        }
                        // activities
                        if (Array.isArray(newData.activities)) {
                            activities = newData.activities;
                        }
                        updateAllAndUrl();
                        lastJsonString = jsonStr;
                        // Sync data to URL
                        const base64 = encodeBase64(jsonStr);
                        const url = new URL(window.location.href);
                        url.searchParams.set('data', base64);
                        history.replaceState(null, '', url.toString());
                    } catch (e) {
                        // ignore invalid JSON
                    }
                }
            }, POLL_INTERVAL);
        }

        // Start polling after DOM loaded
        document.addEventListener('DOMContentLoaded', function() {
            startRealtimeJsonPolling();
        });
        // Toast utility
function showToast(message, type = 'info') {
    let toast = document.createElement('div');
    toast.className = `fixed bottom-6 right-6 z-50 px-4 py-3 rounded shadow-lg text-white font-semibold transition duration-300 ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 400);
    }, 2200);
}

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å input
        function getOwnerName() {
            return document.getElementById('ownerName').value.trim();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ clipboard
        function copyDataUrl() {
            const bgColors = {
                bgDay1: document.getElementById('bgDay1').value,
                bgDay2: document.getElementById('bgDay2').value,
                bgDay3: document.getElementById('bgDay3').value,
                bgNight1: document.getElementById('bgNight1').value,
                bgNight2: document.getElementById('bgNight2').value,
                bgNight3: document.getElementById('bgNight3').value
            };
            const data = {
                owner: getOwnerName(),
                activities: activities.map(a => ({ ...a, color: a.color })),
                background: bgColors
            };
            const jsonStr = JSON.stringify(data);
            const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
            const url = window.location.origin + window.location.pathname + '?data=' + encoded;
            // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ clipboard
            navigator.clipboard.writeText(url).then(function() {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
            }, function() {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            });
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å url parameter ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (base64 decode)
        function loadDataFromUrl() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('data')) {
                try {
                    const encoded = params.get('data');
                    const jsonStr = decodeURIComponent(escape(atob(encoded)));
                    const data = JSON.parse(jsonStr);
                    // owner
                    if (data.owner) {
                        document.getElementById('ownerName').value = data.owner;
                        document.getElementById('clockTitle').innerHTML = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class="text-purple-600">${data.owner}</span>`;
                        document.getElementById('printTitle').textContent = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ${data.owner}`;
                    }
                    // background
                    if (data.background) {
                        document.getElementById('bgDay1').value = data.background.bgDay1 || '#f9d976';
                        document.getElementById('bgDay2').value = data.background.bgDay2 || '#f39c12';
                        document.getElementById('bgDay3').value = data.background.bgDay3 || '#e96443';
                        document.getElementById('bgNight1').value = data.background.bgNight1 || '#232526';
                        document.getElementById('bgNight2').value = data.background.bgNight2 || '#414345';
                        document.getElementById('bgNight3').value = data.background.bgNight3 || '#000000';
                    }
                    // activities
                    if (Array.isArray(data.activities)) {
                        activities = data.activities;
                    }
                    updateClockBackground();
                    updateClock();
                    updateActivityList();
                    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } catch (e) {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ', 'error');
                }
            } else {
                updateClockBackground();
                updateClock();
                updateActivityList();
            }
        }

        // Export all data (activities + background colors) as JSON string
        function exportJson() {
            const bgColors = {
                bgDay1: document.getElementById('bgDay1').value,
                bgDay2: document.getElementById('bgDay2').value,
                bgDay3: document.getElementById('bgDay3').value,
                bgNight1: document.getElementById('bgNight1').value,
                bgNight2: document.getElementById('bgNight2').value,
                bgNight3: document.getElementById('bgNight3').value
            };
            // ‡∏£‡∏ß‡∏°‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢
            const data = {
                activities: activities.map(a => ({
                    ...a,
                    color: a.color
                })),
                background: bgColors
            };
            const jsonStr = JSON.stringify(data, null, 2);
            // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'clocklife_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        // Show activity duration preview instantly
        function updateActivityDurationPreview() {
            const startHour = parseInt(document.getElementById('startHour').value);
            const startMinute = parseInt(document.getElementById('startMinute').value);
            const endHour = parseInt(document.getElementById('endHour').value);
            const endMinute = parseInt(document.getElementById('endMinute').value);
            let start = startHour * 60 + startMinute;
            let end = endHour * 60 + endMinute;
            if (end <= start) end += 24 * 60;
            const duration = ((end - start) / 60).toFixed(1);
            document.getElementById('activityDurationPreview').textContent = `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${duration} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
        }

        ['startHour','startMinute','endHour','endMinute'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateActivityDurationPreview);
        });
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        updateActivityDurationPreview();
        const activityColorInput = document.getElementById('activityColor');
        const activityColorPreview = document.getElementById('activityColorPreview');
        activityColorInput.addEventListener('input', function() {
            activityColorPreview.style.background = activityColorInput.value;
        });
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        activityColorPreview.style.background = activityColorInput.value;
        let activities = [];
        let currentRating = 0;

        // Initialize clock
        function initializeClock() {
            const clockFace = document.getElementById('clockFace');
            // Add hour marks, numbers, and day/night icons
            for (let i = 0; i < 24; i++) {
                // Hour marks - adjust so 12 is at top
                const mark = document.createElement('div');
                mark.className = 'hour-mark';
                const adjustedAngle = ((i + 12) % 24) * 15;
                mark.style.transform = `rotate(${adjustedAngle}deg)`;
                clockFace.appendChild(mark);
                // Hour numbers - adjust so 12 is at top
                const number = document.createElement('div');
                number.className = 'hour-number';
                const adjustedHour = (i + 12) % 24; // Shift by 12 hours so 12 is at top
                const angle = (adjustedHour * 15) * Math.PI / 180;
                const radius = 240;
                const x = 300 + radius * Math.sin(angle);
                const y = 300 - radius * Math.cos(angle);
                number.style.left = x + 'px';
                number.style.top = y + 'px';
                number.textContent = i === 0 ? '24' : i;
                clockFace.appendChild(number);
                // Add day/night icons
                if (i % 6 === 0) { // Show icons every 6 hours
                    const icon = document.createElement('div');
                    icon.className = 'day-night-icon';
                    const iconRadius = 200;
                    const iconX = 300 + iconRadius * Math.sin(angle);
                    const iconY = 300 - iconRadius * Math.cos(angle);
                    icon.style.left = iconX + 'px';
                    icon.style.top = iconY + 'px';
                    icon.style.transform = 'translate(-50%, -50%)';
                    // Determine day/night icon based on hour
                    if (i >= 6 && i < 18) {
                        icon.textContent = '‚òÄÔ∏è'; // Day time
                    } else {
                        icon.textContent = 'üåô'; // Night time
                    }
                    clockFace.appendChild(icon);
                }
            }
            // Add real-time clock hands container (already in HTML)
        }

        // Draw real-time analog clock hands
        function drawRealtimeClockHands() {
            const handsContainer = document.getElementById('realtimeClockHands');
            if (!handsContainer) return;
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const second = now.getSeconds();
            // Calculate angles
            // 24-hour clock: 0/24 at bottom (270deg), 12 at top (90deg)
            // Each hour = 15deg, so angle = (hour + minute/60) * 15
            const hourAngle = ((hour % 24) + minute / 60) * 15;
            const minuteAngle = (minute + second / 60) * 6; // 60min = 360deg
            const secondAngle = second * 6;
            // Shift so 0/24 is at bottom (add 180deg)
            const hourAngleShifted = hourAngle + 180;
            const minuteAngleShifted = minuteAngle + 180;
            const secondAngleShifted = secondAngle + 180;
            // Center of clock
            const centerX = 300;
            const centerY = 300;
            // Lengths
            const hourLen = 120;
            const minLen = 180;
            const secLen = 220;
            // Calculate end points
            function getEnd(angle, length) {
                const rad = (angle - 90) * Math.PI / 180;
                return {
                    x: centerX + length * Math.cos(rad),
                    y: centerY + length * Math.sin(rad)
                };
            }
            const hourEnd = getEnd(hourAngleShifted, hourLen);
            const minEnd = getEnd(minuteAngleShifted, minLen);
            const secEnd = getEnd(secondAngleShifted, secLen);
            // SVG for hands
            handsContainer.innerHTML = `
                <svg width="600" height="600" style="position:absolute;top:0;left:0;pointer-events:none;z-index:30;">
                    <line x1="${centerX}" y1="${centerY}" x2="${hourEnd.x}" y2="${hourEnd.y}" stroke="#222" stroke-width="8" stroke-linecap="round" />
                    <line x1="${centerX}" y1="${centerY}" x2="${minEnd.x}" y2="${minEnd.y}" stroke="#1976d2" stroke-width="5" stroke-linecap="round" />
                    <line x1="${centerX}" y1="${centerY}" x2="${secEnd.x}" y2="${secEnd.y}" stroke="#e53935" stroke-width="2" stroke-linecap="round" />
                    <circle cx="${centerX}" cy="${centerY}" r="12" fill="#fff" stroke="#222" stroke-width="3" />
                </svg>
            `;
        }

        // Start real-time clock hands update
        setInterval(drawRealtimeClockHands, 1000);
        // Draw once on load
        drawRealtimeClockHands();

        // Initialize print clock
        function initializePrintClock() {
            const printClockFace = document.getElementById('printClockFace');
            
            // Clear existing content
            printClockFace.innerHTML = '<div class="center-dot"></div>';
            
            // Add hour marks, numbers, and day/night icons for print version
            for (let i = 0; i < 24; i++) {
                // Hour marks - adjust so 12 is at top
                const mark = document.createElement('div');
                mark.className = 'hour-mark';
                const adjustedAngle = ((i + 12) % 24) * 15;
                mark.style.transform = `rotate(${adjustedAngle}deg)`;
                printClockFace.appendChild(mark);
                
                // Hour numbers - adjust so 12 is at top
                const number = document.createElement('div');
                number.className = 'hour-number';
                const adjustedHour = (i + 12) % 24;
                const angle = (adjustedHour * 15) * Math.PI / 180;
                const radius = 200; // Smaller radius for print
                const x = 250 + radius * Math.sin(angle); // Adjusted for smaller clock
                const y = 250 - radius * Math.cos(angle);
                number.style.left = x + 'px';
                number.style.top = y + 'px';
                number.textContent = i === 0 ? '24' : i;
                printClockFace.appendChild(number);
                
                // Add day/night icons
                if (i % 6 === 0) {
                    const icon = document.createElement('div');
                    icon.className = 'day-night-icon';
                    const iconRadius = 170; // Smaller radius for print
                    const iconX = 250 + iconRadius * Math.sin(angle);
                    const iconY = 250 - iconRadius * Math.cos(angle);
                    icon.style.left = iconX + 'px';
                    icon.style.top = iconY + 'px';
                    icon.style.transform = 'translate(-50%, -50%)';
                    
                    if (i >= 6 && i < 18) {
                        icon.textContent = '‚òÄÔ∏è';
                    } else {
                        icon.textContent = 'üåô';
                    }
                    
                    printClockFace.appendChild(icon);
                }
            }
        }

        // Update owner name
        document.getElementById('ownerName').addEventListener('input', function() {
            const name = this.value.trim();
            const title = document.getElementById('clockTitle');
            const printTitle = document.getElementById('printTitle');
            if (name) {
                title.innerHTML = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class=\"text-purple-600\">${name}</span>`;
                printTitle.textContent = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ${name}`;
            } else {
                title.innerHTML = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: <span class=\"text-purple-600\">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠</span>`;
                printTitle.textContent = `‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠`;
            }
            updateAllAndUrl();
            updateJsonString(); // sync JSON string immediately
        });

        // ‡∏ó‡∏∏‡∏Å event ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI -> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó json -> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó url
        function updateAllAndUrl() {
            updateClockBackground();
            updateClock();
            updateActivityList();
            updateJsonString();
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó json string ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (CRUD)
        function updateJsonString() {
            const bgColors = {
                bgDay1: document.getElementById('bgDay1').value,
                bgDay2: document.getElementById('bgDay2').value,
                bgDay3: document.getElementById('bgDay3').value,
                bgNight1: document.getElementById('bgNight1').value,
                bgNight2: document.getElementById('bgNight2').value,
                bgNight3: document.getElementById('bgNight3').value
            };
            const data = {
                owner: getOwnerName(),
                activities: activities.map(a => ({ ...a, color: a.color })),
                background: bgColors
            };
            window.latestJsonString = JSON.stringify(data, null, 2);
            const jsonBox = document.getElementById('jsonStringBox');
            if (jsonBox && document.activeElement !== jsonBox) {
                jsonBox.value = window.latestJsonString;
            }
        }

        // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà json string ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ url ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        document.addEventListener('DOMContentLoaded', function() {
            const jsonBox = document.getElementById('jsonStringBox');
            if (jsonBox) {
                jsonBox.addEventListener('input', function() {
                    let data;
                    try {
                        data = JSON.parse(jsonBox.value);
                    } catch (e) {
                        showToast('JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                        return;
                    }
                    // owner
                    if (data.owner !== undefined) {
                        document.getElementById('ownerName').value = data.owner;
                    }
                    // background
                    if (data.background) {
                        document.getElementById('bgDay1').value = data.background.bgDay1 || '#f9d976';
                        document.getElementById('bgDay2').value = data.background.bgDay2 || '#f39c12';
                        document.getElementById('bgDay3').value = data.background.bgDay3 || '#e96443';
                        document.getElementById('bgNight1').value = data.background.bgNight1 || '#232526';
                        document.getElementById('bgNight2').value = data.background.bgNight2 || '#414345';
                        document.getElementById('bgNight3').value = data.background.bgNight3 || '#000000';
                    }
                    // activities
                    if (Array.isArray(data.activities)) {
                        activities = data.activities;
                    }
                    updateAllAndUrl();
                });
            }
        });
        // ‡πÉ‡∏´‡πâ background ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ
        ['bgDay1','bgDay2','bgDay3','bgNight1','bgNight2','bgNight3'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                updateAllAndUrl();
            });
        });
        updateClockBackground();

        // Print function
        function printClock() {
            // Update print clock with current activities
            updatePrintClock();
            updatePrintInfo();
            
            // Set print date
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('th-TH');
            
            // Print
            window.print();
        }

        // Update print clock
        function updatePrintClock() {
            initializePrintClock();
            
            const printClockFace = document.getElementById('printClockFace');

            activities.forEach(activity => {
                const segment = document.createElement('div');
                segment.className = 'activity-segment';
                
                const startHour = activity.start / 60;
                let endHour = activity.end / 60;
                
                function hourToAngle(hour) {
                    hour = hour % 24;
                    return ((hour + 12) % 24) * 15;
                }
                
                const startAngleDeg = hourToAngle(startHour);
                let endAngleDeg = hourToAngle(endHour);
                
                if (activity.end > 24 * 60) {
                    endHour = (activity.end - 24 * 60) / 60;
                    endAngleDeg = hourToAngle(endHour);
                }
                
                const startAngle = (startAngleDeg - 90) * Math.PI / 180;
                const endAngle = (endAngleDeg - 90) * Math.PI / 180;
                
                const centerX = 250; // Adjusted for print size
                const centerY = 250;
                const radius = 225;
                const innerRadius = 150;
                
                const x1 = centerX + innerRadius * Math.cos(startAngle);
                const y1 = centerY + innerRadius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(startAngle);
                const y2 = centerY + radius * Math.sin(startAngle);
                const x3 = centerX + radius * Math.cos(endAngle);
                const y3 = centerY + radius * Math.sin(endAngle);
                const x4 = centerX + innerRadius * Math.cos(endAngle);
                const y4 = centerY + innerRadius * Math.sin(endAngle);
                
                let angleDiff = endAngleDeg - startAngleDeg;
                if (activity.end > 24 * 60) {
                    if (angleDiff < 0) angleDiff += 360;
                } else if (angleDiff <= 0) {
                    angleDiff += 360;
                }
                const largeArcFlag = angleDiff > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${x1} ${y1}`,
                    `L ${x2} ${y2}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x3} ${y3}`,
                    `L ${x4} ${y4}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x1} ${y1}`,
                    'Z'
                ].join(' ');
                
                // Text path for print
                const textPathRadius = (innerRadius + radius) / 2;
                const textStartAngle = startAngleDeg - 90;
                const textEndAngle = endAngleDeg - 90;
                
                let textAngleDiff = endAngleDeg - startAngleDeg;
                if (activity.end > 24 * 60) {
                    if (textAngleDiff < 0) textAngleDiff += 360;
                } else if (textAngleDiff <= 0) {
                    textAngleDiff += 360;
                }
                
                const textStartX = centerX + textPathRadius * Math.cos(textStartAngle * Math.PI / 180);
                const textStartY = centerY + textPathRadius * Math.sin(textStartAngle * Math.PI / 180);
                const textEndX = centerX + textPathRadius * Math.cos(textEndAngle * Math.PI / 180);
                const textEndY = centerY + textPathRadius * Math.sin(textEndAngle * Math.PI / 180);
                
                const textLargeArcFlag = textAngleDiff > 180 ? 1 : 0;
                const textPathData = `M ${textStartX} ${textStartY} A ${textPathRadius} ${textPathRadius} 0 ${textLargeArcFlag} 1 ${textEndX} ${textEndY}`;
                
                const uniqueId = `printTextPath_${activity.id}`;
                
                segment.innerHTML = `
                    <svg width="500" height="500" style="position: absolute; top: 0; left: 0;">
                        <defs>
                            <path id="${uniqueId}" d="${textPathData}" />
                        </defs>
                        <path d="${pathData}" fill="${activity.color}" opacity="0.8" stroke="white" stroke-width="2"/>
                        <text fill="white" font-size="12" font-weight="bold">
                            <textPath href="#${uniqueId}" startOffset="50%" text-anchor="middle" dy="6">
                                ${activity.name.length > 10 ? activity.name.substring(0, 10) + '...' : activity.name}
                            </textPath>
                        </text>
                    </svg>
                `;
                
                printClockFace.appendChild(segment);
            });
        }

        // Update print info
        function updatePrintInfo() {
            // Activity list for print
            const printActivityList = document.getElementById('printActivityList');
            if (activities.length === 0) {
                printActivityList.innerHTML = '<p style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>';
            } else {
                printActivityList.innerHTML = activities.map(activity => {
                    const duration = ((activity.end > 24 * 60 ? activity.end - activity.start : activity.end - activity.start) / 60).toFixed(1);
                    return `
                        <div style="margin-bottom: 8px; display: flex; align-items: center;">
                            <div style="width: 12px; height: 12px; background-color: ${activity.color}; border-radius: 2px; margin-right: 8px;"></div>
                            <div style="flex: 1;">
                                <strong>${activity.name}</strong><br>
                                <span style="font-size: 10px; color: #666;">${activity.startTime} - ${activity.endTime} (${duration} ‡∏ä‡∏°.)</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Color legend for print
            const printColorLegend = document.getElementById('printColorLegend');
            const usedColors = [...new Set(activities.map(a => a.color))];
            const colorNames = {
                '#FF6B6B': 'üî¥ ‡∏á‡∏≤‡∏ô/‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                '#4ECDC4': 'üü¢ ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô',
                '#45B7D1': 'üîµ ‡∏Å‡∏µ‡∏¨‡∏≤/‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢',
                '#96CEB4': 'üü° ‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                '#FFEAA7': 'üü† ‡∏™‡∏±‡∏á‡∏Ñ‡∏°/‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô',
                '#DDA0DD': 'üü£ ‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å',
                '#98D8C8': 'ü©µ ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
                '#F7DC6F': 'üü§ ‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö'
            };

            printColorLegend.innerHTML = usedColors.map(color => {
                let label = colorNames[color];
                if (!label) {
                    // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    const acts = activities.filter(a => a.color === color).map(a => a.name);
                    label = acts.length ? acts.join(', ') : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                }
                return `<div style="margin-bottom: 4px; display: flex; align-items: center;">
                    <div style="width: 10px; height: 10px; background-color: ${color}; border-radius: 2px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">${label}</span>
                </div>`;
            }).join('');

            // Statistics for print
            const printStats = document.getElementById('printStats');
            if (activities.length === 0) {
                printStats.innerHTML = '<p style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>';
            } else {
                const stats = {};
                let totalTime = 0;
                
                activities.forEach(activity => {
                    const duration = (activity.end > 24 * 60 ? activity.end - activity.start : activity.end - activity.start) / 60;
                    const colorName = colorNames[activity.color] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                    
                    if (!stats[colorName]) {
                        stats[colorName] = { time: 0, color: activity.color };
                    }
                    stats[colorName].time += duration;
                    totalTime += duration;
                });

                const statsHtml = Object.entries(stats).map(([name, data]) => {
                    const percentage = ((data.time / totalTime) * 100).toFixed(1);
                    return `
                        <div style="margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 10px; height: 10px; background-color: ${data.color}; border-radius: 2px; margin-right: 6px;"></div>
                                <span style="font-size: 10px;">${name}</span>
                            </div>
                            <span style="font-size: 10px; font-weight: bold;">${data.time.toFixed(1)} ‡∏ä‡∏°. (${percentage}%)</span>
                        </div>
                    `;
                }).join('');

                printStats.innerHTML = statsHtml + `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ccc;">
                        <strong style="font-size: 12px;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalTime.toFixed(1)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</strong>
                    </div>
                `;
            }
        }

        // Add activity
        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const startHour = parseInt(document.getElementById('startHour').value);
            const startMinute = parseInt(document.getElementById('startMinute').value);
            const endHour = parseInt(document.getElementById('endHour').value);
            const endMinute = parseInt(document.getElementById('endMinute').value);
            const color = document.getElementById('activityColor').value;

            if (!name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
                return;
            }

            const start = startHour * 60 + startMinute;
            let end = endHour * 60 + endMinute;

            // Handle overnight activities (e.g., 23:00 to 06:00)
            if (end <= start) {
                end += 24 * 60; // Add 24 hours in minutes
            }

            const startTime = `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;
            const endTime = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;

            const activity = {
                id: Date.now(),
                name,
                startTime,
                endTime,
                color,
                start,
                end
            };

            activities.push(activity);
            updateAllAndUrl();
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            console.log('Activity added:', activity); // Debug log
        }

        // Parse time to minutes
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Format time
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // Update clock display
        function updateClock() {
            // Remove existing activity segments
            const existingSegments = document.querySelectorAll('.activity-segment');
            existingSegments.forEach(segment => segment.remove());

            const clockFace = document.getElementById('clockFace');

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì layer ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏î‡πÉ‡∏ô layer ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏Ç‡∏≠‡∏á layers: [{activity, layer}]
            var baseInnerRadius = 120; // ‡∏•‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ß‡∏á‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
            var layerWidth = 20; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞ layer ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
            let layers = [];
            activities.forEach((activity, idx) => {
            // ‡∏´‡∏≤ layer ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô layer ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            let layer = 0;
            while (true) {
                let overlap = layers.some(l => l.layer === layer &&
                ((activity.start < l.activity.end && activity.end > l.activity.start) ||
                 (activity.end > 24*60 && l.activity.end > 24*60 && activity.start < l.activity.end && activity.end > l.activity.start))
                );
                if (!overlap) break;
                layer++;
            }
            layers.push({activity, layer});
            });

            layers.forEach(({activity, layer}) => {
            const segment = document.createElement('div');
            segment.className = 'activity-segment';

            // Convert start and end times to hours (with minutes as decimal)
            const startHour = activity.start / 60;
            let endHour = activity.end / 60;

            function hourToAngle(hour) {
                hour = hour % 24;
                return ((hour + 12) % 24) * 15;
            }

            const startAngleDeg = hourToAngle(startHour);
            let endAngleDeg = hourToAngle(endHour);

            if (activity.end > 24 * 60) {
                endHour = (activity.end - 24 * 60) / 60;
                endAngleDeg = hourToAngle(endHour);
            }

            const startAngle = (startAngleDeg - 90) * Math.PI / 180;
            const endAngle = (endAngleDeg - 90) * Math.PI / 180;

            const centerX = 300;
            const centerY = 300;
            const layerInnerRadius = baseInnerRadius + layer * layerWidth;
            const layerOuterRadius = layerInnerRadius + layerWidth;

            const x1 = centerX + layerInnerRadius * Math.cos(startAngle);
            const y1 = centerY + layerInnerRadius * Math.sin(startAngle);
            const x2 = centerX + layerOuterRadius * Math.cos(startAngle);
            const y2 = centerY + layerOuterRadius * Math.sin(startAngle);
            const x3 = centerX + layerOuterRadius * Math.cos(endAngle);
            const y3 = centerY + layerOuterRadius * Math.sin(endAngle);
            const x4 = centerX + layerInnerRadius * Math.cos(endAngle);
            const y4 = centerY + layerInnerRadius * Math.sin(endAngle);

            let angleDiff = endAngleDeg - startAngleDeg;
            if (activity.end > 24 * 60) {
                if (angleDiff < 0) angleDiff += 360;
            } else if (angleDiff <= 0) {
                angleDiff += 360;
            }
            const largeArcFlag = angleDiff > 180 ? 1 : 0;

            const pathData = [
                `M ${x1} ${y1}`,
                `L ${x2} ${y2}`,
                `A ${layerOuterRadius} ${layerOuterRadius} 0 ${largeArcFlag} 1 ${x3} ${y3}`,
                `L ${x4} ${y4}`,
                `A ${layerInnerRadius} ${layerInnerRadius} 0 ${largeArcFlag} 0 ${x1} ${y1}`,
                'Z'
            ].join(' ');

            // Calculate text position at midpoint of arc
            let midAngleDeg = startAngleDeg + angleDiff / 2;
            if (midAngleDeg >= 360) midAngleDeg -= 360;
            const midAngle = (midAngleDeg - 90) * Math.PI / 180;

            const textRadius = (layerInnerRadius + layerOuterRadius) / 2;
            const textX = centerX + textRadius * Math.cos(midAngle);
            const textY = centerY + textRadius * Math.sin(midAngle);

            // Create curved text path
            const textPathRadius = (layerInnerRadius + layerOuterRadius) / 2;
            const textStartAngle = startAngleDeg - 90;
            const textEndAngle = endAngleDeg - 90;

            let textAngleDiff = endAngleDeg - startAngleDeg;
            if (activity.end > 24 * 60) {
                if (textAngleDiff < 0) textAngleDiff += 360;
            } else if (textAngleDiff <= 0) {
                textAngleDiff += 360;
            }

            const textStartX = centerX + textPathRadius * Math.cos(textStartAngle * Math.PI / 180);
            const textStartY = centerY + textPathRadius * Math.sin(textStartAngle * Math.PI / 180);
            const textEndX = centerX + textPathRadius * Math.cos(textEndAngle * Math.PI / 180);
            const textEndY = centerY + textPathRadius * Math.sin(textEndAngle * Math.PI / 180);

            const textLargeArcFlag = textAngleDiff > 180 ? 1 : 0;
            const textPathData = `M ${textStartX} ${textStartY} A ${textPathRadius} ${textPathRadius} 0 ${textLargeArcFlag} 1 ${textEndX} ${textEndY}`;

            const uniqueId = `textPath_${activity.id}`;

            segment.innerHTML = `
                    <svg width="600" height="600" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                        <defs>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="#000" flood-opacity="0.25"/>
                            </filter>
                            <path id="${uniqueId}" d="${textPathData}" />
                        </defs>
                        <path d="${pathData}" fill="${activity.color}" opacity="0.92" stroke="#fff" stroke-width="4" style="pointer-events: all; cursor: pointer;" filter="url(#shadow)"/>
                        <text fill="#fff" font-size="15" font-weight="bold" style="pointer-events: none;">
                            <textPath href="#${uniqueId}" startOffset="50%" text-anchor="middle">
                                ${activity.name.length > 12 ? activity.name.substring(0, 12) + '...' : activity.name}
                            </textPath>
                        </text>
                    </svg>
            `;

            segment.title = `${activity.name}\n${activity.startTime} - ${activity.endTime}`;
            segment.style.pointerEvents = 'all';
            segment.style.cursor = 'pointer';

            segment.addEventListener('click', function() {
                showActivityDetails(activity);
            });

            clockFace.appendChild(segment);
            });

            updateColorLegend();
        }

        // Update activity list
        function updateActivityList() {
            const list = document.getElementById('activityList');
            if (activities.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>';
                return;
            }
            list.innerHTML = activities.map(activity => {
                const duration = (activity.end > 24 * 60 ? activity.end - activity.start : activity.end - activity.start) / 60;
                const isEditing = activity.isEditing;
                if (isEditing) {
                    // Edit mode
                    setTimeout(() => {
                        const colorInput = document.getElementById(`editColor_${activity.id}`);
                        if (colorInput) {
                            colorInput.addEventListener('input', function() {
                                activities = activities.map(a => a.id === activity.id ? { ...a, color: colorInput.value } : a);
                                updateAllAndUrl(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó url ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            });
                        }
                    }, 0);
                    return `
                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded" style="background-color: ${activity.color}"></div>
                            <div>
                                <input type="text" class="font-medium border rounded px-2 py-1" id="editName_${activity.id}" value="${activity.name}" style="width:120px;">
                                <div class="text-sm text-gray-600">
                                    <input type="time" id="editStart_${activity.id}" value="${activity.startTime}"> - 
                                    <input type="time" id="editEnd_${activity.id}" value="${activity.endTime}">
                                </div>
                                <input type="color" id="editColor_${activity.id}" value="${activity.color}" class="mt-2 p-2 border rounded-lg w-12 h-8" />
                                <div class="text-xs text-gray-500 mt-1">${duration.toFixed(1)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveEditActivity(${activity.id})" class="text-green-600 hover:text-green-800 font-bold text-lg">‚úîÔ∏è</button>
                            <button onclick="cancelEditActivity(${activity.id})" class="text-gray-500 hover:text-gray-700 font-bold text-lg">‚ùå</button>
                        </div>
                    </div>
                    `;
                } else {
                    // Normal mode
                    return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded" style="background-color: ${activity.color}"></div>
                            <div>
                                <div class="font-medium">${activity.name}</div>
                                <div class="text-sm text-gray-600">${activity.startTime} - ${activity.endTime}</div>
                                <div class="text-xs text-gray-500">${duration.toFixed(1)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editActivity(${activity.id})" class="text-blue-500 hover:text-blue-700 font-bold text-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="removeActivity(${activity.id})" class="text-red-500 hover:text-red-700 font-bold text-lg">√ó</button>
                        </div>
                    </div>
                    `;
                }
            }).join('');
        }

        // Update color legend
        function updateColorLegend() {
            const legend = document.getElementById('colorLegend');
            const usedColors = [...new Set(activities.map(a => a.color))];
            

            legend.innerHTML = usedColors.map(color => {
                const acts = activities.filter(a => a.color === color);
                // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
                const label = acts.map(a => `${a.name} (${a.startTime}-${a.endTime})`).join(', ');
                return `<div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded" style="background-color: ${color}"></div>
                    <span class="text-xs">${label}</span>
                </div>`;
            }).join('');
        }

        // Remove activity
        function removeActivity(id) {
            activities = activities.filter(activity => activity.id !== id);
            updateAllAndUrl();
        }

        // Edit activity
        function editActivity(id) {
            activities = activities.map(activity => activity.id === id ? { ...activity, isEditing: true } : { ...activity, isEditing: false });
            updateActivityList();
        }

        // Cancel edit
        function cancelEditActivity(id) {
            activities = activities.map(activity => activity.id === id ? { ...activity, isEditing: false } : activity);
            updateActivityList();
        }

        // Save edit
        function saveEditActivity(id) {
            const nameInput = document.getElementById(`editName_${id}`);
            const startInput = document.getElementById(`editStart_${id}`);
            const endInput = document.getElementById(`editEnd_${id}`);
            const colorInput = document.getElementById(`editColor_${id}`);
            if (!nameInput.value.trim()) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
                return;
            }
            const start = parseTime(startInput.value);
            let end = parseTime(endInput.value);
            if (end <= start) end += 24 * 60;
            activities = activities.map(activity => {
                if (activity.id === id) {
                    return {
                        ...activity,
                        name: nameInput.value.trim(),
                        startTime: startInput.value,
                        endTime: endInput.value,
                        color: colorInput.value,
                        start,
                        end,
                        isEditing: false
                    };
                }
                return activity;
            });
            updateAllAndUrl();
        }

        // Clear form
        function clearForm() {
            document.getElementById('activityName').value = '';
            document.getElementById('startHour').value = '9';
            document.getElementById('startMinute').value = '0';
            document.getElementById('endHour').value = '17';
            document.getElementById('endMinute').value = '0';
        }

        // Rating system
        function setRating(rating) {
            currentRating = rating;
            const buttons = document.querySelectorAll('.rating-btn');
            const ratingText = document.getElementById('ratingText');
            
            buttons.forEach((btn, index) => {
                if (index < rating) {
                    btn.style.color = '#FFD700';
                } else {
                    btn.style.color = '#D1D5DB';
                }
            });

            const ratingTexts = [
                '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
                'üòû ‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏°‡∏≤‡∏Å',
                'üòê ‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à',
                'üòä ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                'üòÑ ‡∏û‡∏≠‡πÉ‡∏à',
                'ü§© ‡∏û‡∏≠‡πÉ‡∏à‡∏°‡∏≤‡∏Å'
            ];
            
            ratingText.textContent = ratingTexts[rating];
        }

        // Save evaluation
        function saveEvaluation() {
            const feedback = document.getElementById('feedback').value.trim();
            
            if (currentRating === 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à', 'error');
                return;
            }

            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${currentRating}/5 ‡∏î‡∏≤‡∏ß${feedback ? ' | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô: ' + feedback : ''}`, 'success');
            // Reset evaluation form
            currentRating = 0;
            document.getElementById('feedback').value = '';
            setRating(0);
        }

        // Show activity details when clicked
        function showActivityDetails(activity) {
            const duration = activity.end > 24 * 60 ? 
                (activity.end - activity.start) / 60 : 
                (activity.end - activity.start) / 60;
            
            const endTimeDisplay = activity.end > 24 * 60 ? 
                `${activity.endTime} (+1 ‡∏ß‡∏±‡∏ô)` : 
                activity.endTime;
            
            showToast(`üìã ${activity.name} | ${activity.startTime} - ${endTimeDisplay} | ${duration.toFixed(1)} ‡∏ä‡∏°. | ‡∏™‡∏µ: ${getColorName(activity.color)}`, 'info');
        }
        
 

        // Initialize the application
        initializeClock();

        function updateClockBackground() {
            const day1 = document.getElementById('bgDay1').value;
            const day2 = document.getElementById('bgDay2').value;
            const day3 = document.getElementById('bgDay3').value;
            const night1 = document.getElementById('bgNight1').value;
            const night2 = document.getElementById('bgNight2').value;
            const night3 = document.getElementById('bgNight3').value;
            const gradient = `linear-gradient(to bottom, ${day1} 0%, ${day2} 20%, ${day3} 40%, ${night1} 60%, ${night2} 80%, ${night3} 100%)`;
            document.querySelector('.clock-face').style.setProperty('--clock-gradient', gradient);
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô bg
            const clockFace = document.getElementById('clockFace');
            clockFace.style.background = gradient;
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö print
            const printClockFace = document.getElementById('printClockFace');
            printClockFace.style.background = gradient;
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó url ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (base64 encoding)
        function updateUrlAuto() {
            const bgColors = {
                bgDay1: document.getElementById('bgDay1').value,
                bgDay2: document.getElementById('bgDay2').value,
                bgDay3: document.getElementById('bgDay3').value,
                bgNight1: document.getElementById('bgNight1').value,
                bgNight2: document.getElementById('bgNight2').value,
                bgNight3: document.getElementById('bgNight3').value
            };
            const data = {
                owner: getOwnerName(),
                activities: activities.map(a => ({ ...a, color: a.color })),
                background: bgColors
            };
            const jsonStr = JSON.stringify(data);
            // base64 encode
            const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
            const url = window.location.origin + window.location.pathname + '?data=' + encoded;
            window.history.replaceState({}, '', url);
        }
    </script>
</body>
</html>
